apiVersion: v1
kind: ConfigMap
metadata:
  name: consumer-migrations
  namespace: app
data:
  000001_containers.up.sql: |
    CREATE TABLE containers (
        id UUID DEFAULT uuid_generate_v7() PRIMARY KEY,
        container_id TEXT NOT NULL UNIQUE,
        owner TEXT,
        container_type TEXT,
        created_at TIMESTAMPTZ DEFAULT NOW()
    );
    CREATE INDEX IF NOT EXISTS containers_container_id_idx ON containers (container_id);

  000001_containers.down.sql: |
    DROP TABLE IF EXISTS containers;

  000002_track_points.up.sql: |
    CREATE TABLE IF NOT EXISTS track_points (
        time TIMESTAMPTZ NOT NULL,
        container_id TEXT NOT NULL,
        lat DOUBLE PRECISION NOT NULL,
        lon DOUBLE PRECISION NOT NULL,
        speed DOUBLE PRECISION,
        CONSTRAINT valid_speed CHECK (
            speed IS NULL
            OR speed >= 0
        )
    );
    -- Idempotent hypertable creation
    SELECT create_hypertable(
            'track_points',
            'time',
            chunk_time_interval => INTERVAL '7 days',
            if_not_exists => TRUE
        );
    CREATE INDEX IF NOT EXISTS track_points_container_time_idx ON track_points (container_id, time DESC);

  000002_track_points.down.sql: |
    DROP TABLE IF EXISTS track_points;

  000003_compression.up.sql: |
    -- Idempotent compression setup
    DO $$ BEGIN
    -- Enable compression if not already enabled
    IF NOT EXISTS (
        SELECT 1
        FROM timescaledb_information.hypertables
        WHERE hypertable_name = 'track_points'
            AND compression_enabled = true
    ) THEN
    ALTER TABLE track_points
    SET (
            timescaledb.compress,
            timescaledb.compress_segmentby = 'container_id',
            timescaledb.compress_orderby = 'time DESC'
        );
    END IF;
    -- Add policies if not exist
    IF NOT EXISTS (
        SELECT 1
        FROM timescaledb_information.jobs
        WHERE hypertable_name = 'track_points'
            AND proc_name = 'policy_compression'
    ) THEN PERFORM add_compression_policy('track_points', INTERVAL '1 day');
    END IF;
    IF NOT EXISTS (
        SELECT 1
        FROM timescaledb_information.jobs
        WHERE hypertable_name = 'track_points'
            AND proc_name = 'policy_retention'
    ) THEN PERFORM add_retention_policy('track_points', INTERVAL '30 days');
    END IF;
    END $$;

  000003_compression.down.sql: |
    SELECT remove_retention_policy('track_points', if_exists => true);
    SELECT remove_compression_policy('track_points', if_exists => true);
    ALTER TABLE track_points
    SET (timescaledb.compress = false);
